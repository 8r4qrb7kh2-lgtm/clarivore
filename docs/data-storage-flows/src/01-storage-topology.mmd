flowchart LR
  subgraph CLIENTS["Runtime Entry Points"]
    C1["Restaurant editor shell<br/>useRestaurantPersistence (10003)<br/>User: manager/owner with restaurant access, app admin<br/>Page: /restaurant, /admin-dashboard<br/>File: app/restaurant/client/useRestaurantPersistence.js"]
    C2["Dashboard/help chat<br/>useManagerChat (9880), HelpContactClient (9552)<br/>User: manager/owner, app admin<br/>Page: /manager-dashboard, /help-contact, /admin-dashboard<br/>Files: app/manager-dashboard/components/manager-dashboard-dom/hooks/useManagerChat.js; app/help-contact/HelpContactClient.js"]
    C3["Account/favorites clients<br/>AccountClient (9005), FavoritesClient (9540), RestaurantsClient (10324)<br/>User: signed-in end users<br/>Page: /account, /favorites, /restaurants<br/>Files: app/account/AccountClient.js; app/favorites/FavoritesClient.js; app/restaurants/RestaurantsClient.js"]
    C4["Order/tablet flows<br/>useOrderFlow (10227), upsertTabletOrder (9833)<br/>User: diners and staff/managers<br/>Page: /restaurant, /kitchen-tablet, /server-tablet<br/>Files: app/restaurant/hooks/useOrderFlow.js; app/lib/tabletOrderPersistence.js"]
    C5["System cron monitor<br/>POST /api/monitor-menus (9278)<br/>User: service key/cron only<br/>Surface: Vercel cron<br/>File: app/api/monitor-menus/route.js"]
  end

  subgraph API["Write APIs and Gateway"]
    A1["POST /api/restaurant-write/stage (9403)<br/>User: manager/owner with restaurant access, app admin<br/>Page: /restaurant, /admin-dashboard<br/>File: app/api/restaurant-write/stage/route.js"]
    A2["POST /api/restaurant-write/commit (9397)<br/>User: manager/owner with restaurant access, app admin<br/>Page: /restaurant, /admin-dashboard<br/>File: app/api/restaurant-write/commit/route.js"]
    A3["POST /api/restaurant-write/system (9406)<br/>User: internal system key only<br/>Surface: service-to-service<br/>File: app/api/restaurant-write/system/route.js"]
    A4["applyWriteOperations (9396)<br/>File: app/api/restaurant-write/_shared/writeGatewayUtils.js"]
    A5["setRestaurantWriteContext (9393)<br/>File: app/api/restaurant-write/_shared/writeGatewayUtils.js"]
    A6["syncIngredientStatusFromOverlays (9391)<br/>File: app/api/restaurant-write/_shared/writeGatewayUtils.js"]
    A7["applyMonitoringStatsWrite (9277)<br/>File: app/api/monitor-menus/route.js"]
    A8["POST /api/report-issue (9312)<br/>User: any user (guest or signed-in)<br/>Page: /help-contact, /report-issue<br/>File: app/api/report-issue/route.js"]
    A9["POST /api/ingredient-scan-appeals (9264)<br/>User: authenticated manager/owner for restaurant or app admin<br/>Page: /restaurant<br/>File: app/api/ingredient-scan-appeals/route.js"]
    A10["POST /api/order-feedback/submit (9309)<br/>User: feedback-token holder<br/>Page: /order-feedback<br/>File: app/api/order-feedback/submit/route.js"]
    A11["POST /api/admin/managers (9077)<br/>User: app admin<br/>Page: /admin-dashboard<br/>File: app/api/admin/managers/route.js"]
  end

  subgraph BOUNDARY["Restaurant Boundary Tables (trigger-enforced)"]
    T1["restaurants"]
    T2["change_logs"]
    T3["restaurant_menu_pages"]
    T4["restaurant_menu_dishes"]
    T5["restaurant_menu_ingredient_rows"]
    T6["restaurant_menu_ingredient_brand_items"]
    T7["dish_ingredient_rows"]
    T8["dish_ingredient_allergens"]
    T9["dish_ingredient_diets"]
    TR["Trigger: enforce_restaurant_gateway_context()"]
  end

  subgraph STAGING["Gateway Staging Tables"]
    S1["restaurant_write_batches"]
    S2["restaurant_write_ops"]
  end

  subgraph NONBOUNDARY["Sanctioned Non-Boundary Tables"]
    N1["user_allergies, user_favorites, user_loved_dishes"]
    N2["tablet_orders"]
    N3["order_feedback, accommodation_requests, feedback_email_queue"]
    N4["restaurant_direct_messages, restaurant_direct_message_reads"]
    N5["ingredient_scan_appeals, product_issue_reports"]
    N6["manager_device_tokens, manager_push_subscriptions, diner_device_tokens, diner_push_subscriptions"]
    N7["restaurant_managers, manager_invites"]
    N8["menu_snapshots"]
  end

  C1 --> A1 --> S1
  A1 --> S2
  C1 --> A2 --> A4
  C5 --> A7 --> A4
  C5 --> N8
  A3 --> A4
  A4 --> A5 --> TR
  A4 --> A6
  A6 --> T3
  A6 --> T4
  A6 --> T5
  A6 --> T6
  A6 --> T7
  A6 --> T8
  A6 --> T9
  A4 --> T1
  A4 --> T2

  C3 --> N1
  C4 --> N2
  A10 --> N3
  C2 --> N4
  A9 --> N5
  A8 --> N5
  C2 --> N6
  A11 --> N7
