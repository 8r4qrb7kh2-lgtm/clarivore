flowchart LR
  subgraph CLIENTS["Runtime Entry Points"]
    C1["Restaurant editor shell\nuseRestaurantPersistence (10003)\nUser: manager/owner with restaurant access, app admin\nPage: /restaurant, /admin-dashboard"]
    C2["Dashboard/help chat\nuseManagerChat (9880), HelpContactClient (9552)\nUser: manager/owner, app admin\nPage: /manager-dashboard, /help-contact, /admin-dashboard"]
    C3["Account/favorites clients\nAccountClient (9005), FavoritesClient (9540), RestaurantsClient (10324)\nUser: signed-in end users\nPage: /account, /favorites, /restaurants"]
    C4["Order/tablet flows\nuseOrderFlow (10227), upsertTabletOrder (9833)\nUser: diners and staff/managers\nPage: /restaurant, /kitchen-tablet, /server-tablet"]
    C5["System cron monitor\nPOST /api/monitor-menus (9278)\nUser: service key/cron only\nSurface: Vercel cron"]
  end

  subgraph API["Write APIs and Gateway"]
    A1["POST /api/restaurant-write/stage (9403)\nUser: manager/owner with restaurant access, app admin\nPage: /restaurant, /admin-dashboard"]
    A2["POST /api/restaurant-write/commit (9397)\nUser: manager/owner with restaurant access, app admin\nPage: /restaurant, /admin-dashboard"]
    A3["POST /api/restaurant-write/system (9406)\nUser: internal system key only\nSurface: service-to-service"]
    A4["applyWriteOperations (9396)"]
    A5["setRestaurantWriteContext (9393)"]
    A6["syncIngredientStatusFromOverlays (9391)"]
    A7["applyMonitoringStatsWrite (9277)"]
    A8["POST /api/report-issue (9312)\nUser: any user (guest or signed-in)\nPage: /help-contact, /report-issue"]
    A9["POST /api/ingredient-scan-appeals (9264)\nUser: authenticated manager/owner for restaurant or app admin\nPage: /restaurant"]
    A10["POST /api/order-feedback/submit (9309)\nUser: feedback-token holder\nPage: /order-feedback"]
    A11["POST /api/admin/managers (9077)\nUser: app admin\nPage: /admin-dashboard"]
  end

  subgraph BOUNDARY["Restaurant Boundary Tables (trigger-enforced)"]
    T1["restaurants"]
    T2["change_logs"]
    T3["restaurant_menu_pages"]
    T4["restaurant_menu_dishes"]
    T5["restaurant_menu_ingredient_rows"]
    T6["restaurant_menu_ingredient_brand_items"]
    T7["dish_ingredient_rows"]
    T8["dish_ingredient_allergens"]
    T9["dish_ingredient_diets"]
    TR["Trigger: enforce_restaurant_gateway_context()"]
  end

  subgraph STAGING["Gateway Staging Tables"]
    S1["restaurant_write_batches"]
    S2["restaurant_write_ops"]
  end

  subgraph NONBOUNDARY["Sanctioned Non-Boundary Tables"]
    N1["user_allergies, user_favorites, user_loved_dishes"]
    N2["tablet_orders"]
    N3["order_feedback, accommodation_requests, feedback_email_queue"]
    N4["restaurant_direct_messages, restaurant_direct_message_reads"]
    N5["ingredient_scan_appeals, product_issue_reports"]
    N6["manager_device_tokens, manager_push_subscriptions, diner_device_tokens, diner_push_subscriptions"]
    N7["restaurant_managers, manager_invites"]
    N8["menu_snapshots"]
  end

  C1 --> A1 --> S1
  A1 --> S2
  C1 --> A2 --> A4
  C5 --> A7 --> A4
  C5 --> N8
  A3 --> A4
  A4 --> A5 --> TR
  A4 --> A6
  A6 --> T3
  A6 --> T4
  A6 --> T5
  A6 --> T6
  A6 --> T7
  A6 --> T8
  A6 --> T9
  A4 --> T1
  A4 --> T2

  C3 --> N1
  C4 --> N2
  A10 --> N3
  C2 --> N4
  A9 --> N5
  A8 --> N5
  C2 --> N6
  A11 --> N7
