<!doctype html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
  <title>Clarivore - Safe dining for everyone</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    :root {
      --bg: #0b1020;
      --panel: #111630;
      --ink: #e9ecff;
      --muted: #a8b2d6;
      --brand: #7c9cff;
      --ok: #22c55e;
      --warn: #facc15;
      --bad: #ef4444;
      --border: #2a3261;
      --hover: #4c5ad4;
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    html {
      margin: 0;
      padding: 0;
      min-height: 100%;
      width: 100%;
      overflow: auto;
      background: var(--bg);
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      width: 100%;
      background: var(--bg);
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      overflow-x: hidden;
      overflow-y: auto;
    }

    #root {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-top: max(20px, env(safe-area-inset-top, 0px));
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 8px 10px;
      border: 1px solid var(--border);
      background: #12183a;
      border-radius: 999px;
      font-size: 14px;
    }

    .chip.active {
      border-color: #4c5ad4;
      box-shadow: 0 0 0 3px #7c9cff33 inset, 0 0 10px #24307a66;
    }

    .chip.clickable {
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .pill {
      padding: 10px 14px;
      border: 1px dashed #33408c;
      border-radius: 12px;
      margin-bottom: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #1a2351;
      cursor: pointer;
      color: #fff;
      text-decoration: none;
    }

    .banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: #351b1b;
      border: 1px solid #5b2c2c;
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0;
    }

    .ackBtn {
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid;
    }

    @keyframes ackPulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 180, 180, 0.45); }
      50% { box-shadow: 0 0 0 8px rgba(255, 180, 180, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 180, 180, 0); }
    }

    .ackBtn.off {
      background: #8b1d1d;
      border-color: #a12525;
      animation: ackPulse 1.8s ease-in-out infinite;
    }

    .ackBtn.on {
      background: #17663a;
      border-color: #1a7b46;
      animation: none;
    }

    .topin {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 12px 22px 10px;
      flex-wrap: wrap;
      justify-content: center;
      box-sizing: border-box;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 800;
      flex-shrink: 0;
      cursor: pointer;
      justify-content: center;
      width: 100%;
      text-align: center;
    }

    .brand img {
      width: 52px;
      height: 52px;
      border-radius: 6px;
    }

    .brand span {
      font-size: clamp(1.5rem, 1.3rem + 1vw, 2.1rem);
    }

    .topNav {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .tab {
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: #12183a;
      border-radius: 999px;
      cursor: pointer;
      white-space: nowrap;
    }

    .tab:hover {
      border-color: var(--hover);
      box-shadow: 0 0 0 3px #7c9cff33 inset, 0 2px 10px #0b1b60aa;
    }

    .restaurant-directory {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px;
      box-shadow: var(--shadow);
    }

    .restaurant-directory h2 {
      margin: 0 0 6px 0;
      font-size: 1.4rem;
    }

    .restaurant-directory p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .restaurant-directory #restaurantSearchWrap {
      width: 100%;
    }

    .restaurant-grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .restaurant-card {
      background: #0f1638;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      min-height: 210px;
    }

    .restaurant-card:hover {
      transform: translateY(-3px);
      border-color: var(--hover);
      box-shadow: 0 10px 24px rgba(12, 18, 56, 0.6);
    }

    .restaurant-card.selected {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(124, 156, 255, 0.25);
    }

    .restaurant-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      background: #0b1020;
    }

    .restaurant-card .card-body {
      padding: 12px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }

    .restaurant-card h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--ink);
    }

    .restaurant-card .card-meta {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .restaurant-loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 18px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      color: var(--muted);
    }

    .selected-restaurant {
      padding: 12px 16px;
      background: #1e2a5e;
      border: 2px solid var(--brand);
      border-radius: 12px;
      margin-bottom: 16px;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .selected-restaurant.visible {
      display: flex;
    }

    .selected-restaurant img {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .selected-restaurant h3 {
      font-size: 1.05rem;
      margin: 0;
      color: var(--ink);
    }

    .preferences-panel {
      display: none;
      margin-top: 20px;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      background: #0b1020;
      color: var(--ink);
      border-radius: 10px;
      font-size: 1rem;
      margin-top: 12px;
      outline: none;
      font-family: inherit;
      box-sizing: border-box;
    }

    .search-input:focus {
      border-color: var(--hover);
      box-shadow: 0 0 0 3px rgba(76, 90, 212, 0.2);
    }

    .error-text {
      color: var(--bad);
      font-size: 0.9rem;
      margin: 8px 0;
      display: none;
    }

    .error-text.visible {
      display: block;
    }

    @media (max-width: 640px) {
      .restaurant-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .restaurant-card {
        min-height: 170px;
      }

      .restaurant-card img {
        height: 110px;
      }

      .restaurant-card .card-body {
        padding: 10px 12px 12px;
        gap: 4px;
      }

      .restaurant-card h3 {
        font-size: 0.9rem;
      }

      .restaurant-card .card-meta {
        font-size: 0.78rem;
      }
    }

    /* QR guest promo popup */
    .qrPromoBackdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(8, 12, 32, .85);
      z-index: 2500;
    }

    .qrPromoBackdrop.show {
      display: flex;
    }

    .qrPromo {
      width: min(420px, calc(100% - 40px));
      background: linear-gradient(135deg, #1a2351 0%, #0f1638 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
      position: relative;
    }

    .qrPromo h2 {
      margin: 0 0 16px 0;
      font-size: 1.5rem;
      color: var(--ink);
    }

    .qrPromo p {
      margin: 0 0 12px 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .qrPromo p:last-of-type {
      margin-bottom: 24px;
    }

    .qrPromoClose {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border: none;
      background: #1e2870;
      color: var(--ink);
      font-size: 24px;
      line-height: 1;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qrPromoClose:hover {
      background: #2a3590;
    }

    .qrPromoClose:active {
      background: #1e2870;
    }

    .btnPrimary {
      width: 100%;
      padding: 12px 24px;
      background: var(--brand);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btnPrimary:hover {
      background: #6b8dff;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(124, 156, 255, 0.4);
    }

    .btnPrimary:active {
      transform: translateY(0);
    }

    /* QR banner at top */
    .qrBanner {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      z-index: 2200;
      display: none;
      background: linear-gradient(135deg, #1a2351 0%, #0f1638 100%);
      border-bottom: 1px solid var(--border);
      padding: calc(12px + env(safe-area-inset-top, 0px)) 16px 12px;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .4);
      text-align: center;
    }

    .qrBanner.show {
      display: flex;
    }

    .qrBanner > div {
      color: var(--ink);
      font-size: 0.95rem;
    }

    .qrBanner strong {
      color: var(--brand);
    }

    body.qrBannerVisible .simple-topbar {
      margin-top: calc(80px + env(safe-area-inset-top, 0px));
    }

    @media (max-width: 640px) {
      .qrPromo {
        padding: 24px 20px;
      }

      .qrPromo h2 {
        font-size: 1.25rem;
      }

      .qrBanner {
        font-size: 0.85rem;
      }

      body.qrBannerVisible .simple-topbar {
        margin-top: calc(100px + env(safe-area-inset-top, 0px));
      }
    }
  </style>
</head>
<body>
  <header class="simple-topbar">
    <div class="simple-topbar-inner" id="topbar"></div>
  </header>
  <div id="root"></div>

  <!-- QR Promo Popup -->
  <div class="qrPromoBackdrop" id="qrPromoBackdrop" aria-hidden="true">
    <div class="qrPromo" role="dialog" aria-labelledby="qrPromoTitle" aria-modal="true">
      <button class="qrPromoClose" id="qrPromoClose" type="button" aria-label="Close promotion">Ã—</button>
      <h2 id="qrPromoTitle">Check out all restaurants part of Clarivore</h2>
      <p>Save your allergens and diets once and unlock curated menus at restaurants across the city.</p>
      <p>Creating an account takes less than a minute and is completely free.</p>
      <button class="btn btnPrimary" id="qrPromoSignup" type="button">Create free account</button>
    </div>
  </div>

  <!-- QR Banner at Top -->
  <div class="qrBanner" id="qrBanner" aria-hidden="true">
    <div><strong>Keep exploring safely.</strong> Create a free account to save your allergens and diets, and see compatible dishes everywhere.</div>
    <button class="btn btnPrimary" id="qrBannerSignup" type="button">Create free account</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth-redirect.js" defer></script>
  <script src="js/allergen-diet-config.js"></script>
  <script>
    const SUPABASE_URL = 'https://fgoiyycctnwnghrvsilt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnb2l5eWNjdG53bmdocnZzaWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1MjYsImV4cCI6MjA3NjAxMjUyNn0.xlSSXr0Gl7j-vsckrj-2anpPmp4BG2SUIdN-_dquSA8';
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    document.body.style.display = 'none';
    window.supabaseClient = supabaseClient;

    let allergenConfig = {};
    let ALLERGENS = [];
    let DIETS = [];
    let normalizeAllergen = (value) => {
      const raw = String(value ?? '').trim();
      if (!raw) return '';
      if (!ALLERGENS.length) return raw;
      return ALLERGENS.includes(raw) ? raw : '';
    };
    let normalizeDietLabel = (value) => {
      const raw = String(value ?? '').trim();
      if (!raw) return '';
      if (!DIETS.length) return raw;
      return DIETS.includes(raw) ? raw : '';
    };
    let formatAllergenLabel = (value) => value;
    let getAllergenEmoji = () => '';
    let getDietEmoji = () => '';

    async function loadAllergenConfig() {
      allergenConfig = window.loadAllergenDietConfig
        ? await window.loadAllergenDietConfig({ supabaseClient })
        : (window.ALLERGEN_DIET_CONFIG || {});
      ALLERGENS = Array.isArray(allergenConfig.ALLERGENS) ? allergenConfig.ALLERGENS : [];
      DIETS = Array.isArray(allergenConfig.DIETS) ? allergenConfig.DIETS : [];
      normalizeAllergen = typeof allergenConfig.normalizeAllergen === 'function'
        ? allergenConfig.normalizeAllergen
        : (value) => {
            const raw = String(value ?? '').trim();
            if (!raw) return '';
            if (!ALLERGENS.length) return raw;
            return ALLERGENS.includes(raw) ? raw : '';
          };
      normalizeDietLabel = typeof allergenConfig.normalizeDietLabel === 'function'
        ? allergenConfig.normalizeDietLabel
        : (value) => {
            const raw = String(value ?? '').trim();
            if (!raw) return '';
            if (!DIETS.length) return raw;
            return DIETS.includes(raw) ? raw : '';
          };
      formatAllergenLabel = typeof allergenConfig.formatAllergenLabel === 'function'
        ? allergenConfig.formatAllergenLabel
        : (value) => value;
      getAllergenEmoji = typeof allergenConfig.getAllergenEmoji === 'function'
        ? allergenConfig.getAllergenEmoji
        : () => '';
      getDietEmoji = typeof allergenConfig.getDietEmoji === 'function'
        ? allergenConfig.getDietEmoji
        : () => '';
    }

    const state = { allergies: [], diets: [], ack: false, user: { loggedIn: false } };
    let selectedRestaurant = null;
    let allRestaurants = [];
    let qrPromoTimerId = null;
    const AUTH_STORAGE_KEY = 'sb-fgoiyycctnwnghrvsilt-auth-token';

    function hasStoredAccountInfo() {
      try {
        return !!localStorage.getItem(AUTH_STORAGE_KEY);
      } catch (_) {
        return false;
      }
    }

    async function maybeRedirectToSignIn() {
      if (!hasStoredAccountInfo()) return false;
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session?.user) return false;
      window.location.replace('account.html?mode=signin');
      return true;
    }

    // QR Promo Functions
    function showQrBanner() {
      const banner = document.getElementById('qrBanner');
      if (!banner) return;
      if (state.user?.loggedIn) return;
      banner.classList.add('show');
      banner.setAttribute('aria-hidden', 'false');
      document.body.classList.add('qrBannerVisible');
    }

    function hideQrBanner() {
      const banner = document.getElementById('qrBanner');
      if (!banner) return;
      banner.classList.remove('show');
      banner.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('qrBannerVisible');
    }

    function openQrPromo() {
      const backdrop = document.getElementById('qrPromoBackdrop');
      if (!backdrop || backdrop.classList.contains('show')) return;
      hideQrBanner();
      backdrop.classList.add('show');
      backdrop.setAttribute('aria-hidden', 'false');
    }

    function closeQrPromo(reason = 'dismiss') {
      const backdrop = document.getElementById('qrPromoBackdrop');
      if (backdrop && backdrop.classList.contains('show')) {
        backdrop.classList.remove('show');
        backdrop.setAttribute('aria-hidden', 'true');
      }
      if (qrPromoTimerId) {
        clearTimeout(qrPromoTimerId);
        qrPromoTimerId = null;
      }
      if (reason === 'dismiss' && !state.user?.loggedIn) {
        showQrBanner();
      }
      if (reason === 'signup' || reason === 'login') {
        hideQrBanner();
      }
    }

    function queueQrPromoTimer() {
      if (qrPromoTimerId) {
        clearTimeout(qrPromoTimerId);
        qrPromoTimerId = null;
      }
      qrPromoTimerId = setTimeout(() => {
        qrPromoTimerId = null;
        if (!state.user?.loggedIn) {
          openQrPromo();
        }
      }, 10000); // 10 seconds
    }

    // Helper functions
    const norm = s => (s || '').toString().trim().toLowerCase();
    const esc = s => (s ?? '').toString().replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    function div(html, cls) { const d = document.createElement('div'); if (cls) d.className = cls; d.innerHTML = html; return d; }

    function renderSelector(el) {
      el.innerHTML = '';
      const row = div('', 'chips');
      row.setAttribute('role', 'list');
      const sel = new Set((state.allergies || []).map(normalizeAllergen).filter(Boolean));
      ALLERGENS.forEach(a => {
        const isActive = sel.has(a);
        const emoji = getAllergenEmoji(a) || 'ðŸ”´';
        const c = div(`${emoji} ${esc(formatAllergenLabel(a))}`, 'chip clickable' + (isActive ? ' active' : ''));
        c.setAttribute('role', 'button');
        c.setAttribute('tabindex', '0');
        c.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        c.dataset.value = a;
        const toggle = () => {
          if (sel.has(a)) {
            sel.delete(a);
          } else {
            sel.add(a);
          }
          state.allergies = [...sel];
          try { sessionStorage.setItem('qrAllergies', JSON.stringify(state.allergies)); } catch (_) { }
          renderSelector(el);
          hideError('allergyError');
        };
        c.addEventListener('click', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('touchend', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('keydown', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            toggle();
          }
        });
        row.appendChild(c);
      });
      el.appendChild(row);
    }

    function renderDietSelector(el) {
      el.innerHTML = '';
      const row = div('', 'chips');
      row.setAttribute('role', 'list');
      const sel = new Set((state.diets || []).map(normalizeDietLabel).filter(Boolean));
      DIETS.forEach(diet => {
        const isActive = sel.has(diet);
        const emoji = getDietEmoji(diet) || 'ðŸ½ï¸';
        const c = div(`${emoji} ${esc(diet)}`, 'chip clickable' + (isActive ? ' active' : ''));
        c.setAttribute('role', 'button');
        c.setAttribute('tabindex', '0');
        c.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        c.dataset.value = diet;
        const toggle = () => {
          if (sel.has(diet)) {
            sel.delete(diet);
          } else {
            sel.add(diet);
          }
          state.diets = [...sel];
          try { sessionStorage.setItem('qrDiets', JSON.stringify(state.diets)); } catch (_) { }
          renderDietSelector(el);
          hideError('allergyError');
        };
        c.addEventListener('click', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('touchend', (evt) => {
          evt.preventDefault();
          evt.stopPropagation();
          toggle();
        }, { passive: false });
        c.addEventListener('keydown', (evt) => {
          if (evt.key === 'Enter' || evt.key === ' ') {
            evt.preventDefault();
            toggle();
          }
        });
        row.appendChild(c);
      });
      el.appendChild(row);
    }

    function showError(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('visible');
    }

    function hideError(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('visible');
    }

    async function loadRestaurants() {
      try {
        const { data, error } = await supabaseClient
          .from('restaurants')
          .select('*')
          .order('name');

        if (error) throw error;

        allRestaurants = data || [];
        renderRestaurantGrid(allRestaurants);
        showRestaurantSearch();
      } catch (error) {
        console.error('Error loading restaurants:', error);
      }
    }

    function showRestaurantSearch() {
      const searchWrap = document.getElementById('restaurantSearchWrap');
      if (searchWrap) {
        searchWrap.style.display = 'block';
      }
    }

    function renderRestaurantGrid(restaurants) {
      const grid = document.getElementById('restaurantGrid');
      if (!grid) return;

      if (!restaurants.length) {
        grid.innerHTML = '<div class="restaurant-loading">No restaurants found</div>';
        return;
      }

      grid.innerHTML = restaurants.map(r => {
        const menuImage = r.menu_images && r.menu_images.length > 0
          ? r.menu_images[0]
          : (r.menu_image || 'https://via.placeholder.com/400x260/1a2351/7c9cff?text=Menu');

        const isSelected = selectedRestaurant?.id === r.id;

        return `
          <div class="restaurant-card ${isSelected ? 'selected' : ''}"
               data-id="${r.id}"
               data-slug="${esc(r.slug)}"
               data-name="${esc(r.name)}"
               data-image="${esc(menuImage)}">
            <img src="${esc(menuImage)}" alt="${esc(r.name)}">
            <div class="card-body">
              <h3>${esc(r.name)}</h3>
              <div class="card-meta">View menu</div>
            </div>
          </div>
        `;
      }).join('');

      grid.querySelectorAll('.restaurant-card').forEach(card => {
        card.addEventListener('click', function() {
          const id = parseInt(this.dataset.id, 10);
          const slug = this.dataset.slug;
          const name = this.dataset.name;
          const image = this.dataset.image;
          selectRestaurant(id, slug, name, image);
        });
      });
    }

    window.selectRestaurant = function(id, slug, name, image) {
      selectedRestaurant = { id, slug, name, image };

      // Update search input placeholder and clear value
      const searchInput = document.getElementById('restaurantSearch');
      const hadQuery = searchInput ? searchInput.value.trim() : '';
      if (searchInput) {
        searchInput.value = '';
        searchInput.placeholder = 'Search again...';
      }
      if (hadQuery) {
        renderRestaurantGrid(allRestaurants);
      } else {
        // Update selected card highlight without re-render
        const grid = document.getElementById('restaurantGrid');
        if (grid) {
          grid.querySelectorAll('.restaurant-card').forEach(card => {
            const cardId = parseInt(card.dataset.id, 10);
            card.classList.toggle('selected', cardId === id);
          });
        }
      }

      // Show selected restaurant display with thumbnail
      const selectedDisplay = document.getElementById('selectedRestaurant');
      if (selectedDisplay) {
        selectedDisplay.innerHTML = `
          <img src="${esc(image)}" alt="${esc(name)}">
          <h3>${esc(name)}</h3>
        `;
        selectedDisplay.classList.add('visible');
      }

      const preferencesPanel = document.getElementById('preferencesPanel');
      if (preferencesPanel) {
        preferencesPanel.style.display = 'block';
        preferencesPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      hideError('restaurantError');
      const banner = document.getElementById('disclaimerBanner');
      if (banner) banner.style.display = 'flex';
    };

    function setupListeners() {
      const searchInput = document.getElementById('restaurantSearch');

      if (searchInput) {
        // Filter as user types
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase().trim();

          const filtered = allRestaurants.filter(r =>
            r.name.toLowerCase().includes(query) ||
            r.slug.toLowerCase().includes(query)
          );
          renderRestaurantGrid(query ? filtered : allRestaurants);
        });
      }

      const ackBtn = document.getElementById('ackBtn');
      if (ackBtn) {
        ackBtn.addEventListener('click', function() {
          const hasSelection = state.allergies.length > 0 || state.diets.length > 0;

          if (!hasSelection) {
            showError('allergyError');
            document.getElementById('allergyError').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }

          if (!selectedRestaurant) {
            showError('restaurantError');
            document.getElementById('restaurantError').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
          }

          try {
            sessionStorage.setItem('qrAllergies', JSON.stringify(state.allergies));
            sessionStorage.setItem('qrDiets', JSON.stringify(state.diets));
          } catch (e) {
            console.warn('Could not save to sessionStorage:', e);
          }

          this.textContent = 'Acknowledged';
          this.classList.remove('off');
          this.classList.add('on');

          window.location.href = `restaurant.html?slug=${selectedRestaurant.slug}&qr=1&ack=1`;
        });
      }

      // QR Promo event listeners
      const qrPromoBackdrop = document.getElementById('qrPromoBackdrop');
      const qrPromoCloseBtn = document.getElementById('qrPromoClose');
      const qrPromoSignupBtn = document.getElementById('qrPromoSignup');
      const qrBannerSignupBtn = document.getElementById('qrBannerSignup');

      if (qrPromoBackdrop) {
        qrPromoBackdrop.addEventListener('click', (e) => {
          if (e.target === qrPromoBackdrop) closeQrPromo('dismiss');
        });
      }

      if (qrPromoCloseBtn) {
        qrPromoCloseBtn.onclick = () => closeQrPromo('dismiss');
      }

      if (qrPromoSignupBtn) {
        qrPromoSignupBtn.onclick = () => {
          closeQrPromo('signup');
          window.location.href = 'account.html';
        };
      }

      if (qrBannerSignupBtn) {
        qrBannerSignupBtn.onclick = () => {
          hideQrBanner();
          window.location.href = 'account.html';
        };
      }
    }

    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) {
        state.user.loggedIn = true;
        state.user.data = user;
        const { data: record } = await supabaseClient
          .from('user_allergies')
          .select('allergens, diets')
          .eq('user_id', user.id)
          .maybeSingle();

        if (record) {
          state.allergies = (record.allergens || []).map(normalizeAllergen).filter(Boolean);
          state.diets = (record.diets || []).map(normalizeDietLabel).filter(Boolean);
          renderSelector(document.getElementById('savedChips'));
          renderDietSelector(document.getElementById('dietChips'));
        }
      }
      return state.user.loggedIn;
    }

    async function renderTopbar() {
      const topbar = document.getElementById('topbar');
      if (!topbar) return;
      const [{ setupTopbar }, { fetchManagerRestaurants }] = await Promise.all([
        import('./js/shared-nav.js'),
        import('./js/manager-context.js'),
      ]);

      const navUser = state.user?.loggedIn ? state.user.data : null;
      const isOwner = navUser?.email === 'matt.29.ds@gmail.com';
      const isManager = navUser?.user_metadata?.role === 'manager';
      let managerRestaurants = [];
      if (navUser && (isOwner || isManager)) {
        managerRestaurants = await fetchManagerRestaurants(supabaseClient, navUser.id);
      }

      setupTopbar('home', navUser, {
        container: topbar,
        brandHref: navUser ? 'home.html' : 'index.html',
        managerRestaurants,
      });
    }

    async function render() {
      const root = document.getElementById('root');
      root.innerHTML = `
    <div style="max-width:1100px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:20px">
      <div class="restaurant-directory">
        <h2>Choose a restaurant</h2>
        <p>Search or browse every menu, then tell us about your allergies and diets.</p>
        <div id="restaurantSearchWrap" style="display:none">
          <input type="text" class="search-input" id="restaurantSearch" placeholder="Search for a restaurant...">
        </div>
        <div class="restaurant-grid" id="restaurantGrid">
          <div class="restaurant-loading">Loading restaurants...</div>
        </div>
        <p class="error-text" id="restaurantError">Please select a restaurant</p>
      </div>

      <div class="preferences-panel" id="preferencesPanel">
        <div class="selected-restaurant" id="selectedRestaurant"></div>
        <div class="pill">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
            <div style="font-weight:600">Select Your Allergens</div>
          </div>
          <div id="savedChips"></div>
        </div>
        <div class="pill">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;flex-wrap:wrap;gap:8px">
            <div style="font-weight:600">Diets</div>
          </div>
          <div id="dietChips"></div>
        </div>
        <p class="error-text" id="allergyError">Please select at least one allergen or diet</p>
        <div class="banner" id="disclaimerBanner" style="display:none">
          <span>Reference only. Ingredients & practices can change. Always inform staff about your allergens.</span>
          <button class="ackBtn off" id="ackBtn">I understand</button>
        </div>
      </div>
    </div>
      `;

      renderSelector(document.getElementById('savedChips'));
      renderDietSelector(document.getElementById('dietChips'));

      // Wait for auth check to complete before rendering navigation and queueing promo
      const isLoggedIn = await checkAuth();
      renderTopbar();

      loadRestaurants();
      setupListeners();

      // Promo is handled after the disclaimer on the restaurant view
    }

    async function init() {
      let redirected = false;
      try {
        redirected = await maybeRedirectToSignIn();
      } catch (err) {
        console.warn('Redirect check failed:', err);
      }
      if (redirected) return;
      await loadAllergenConfig();
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          window.location.replace('home.html');
          return;
        }
      } catch (err) {
        console.warn('Auth check failed:', err);
      }
      document.body.style.display = '';
      render();
    }

    init();
  </script>
</body>
</html>
