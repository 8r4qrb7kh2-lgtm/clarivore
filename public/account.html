<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Account Settings - Clarivore</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="page-shell">
  <header class="simple-topbar">
    <div class="simple-topbar-inner">
      <a class="simple-brand" href="home.html">
        <img src="https://static.wixstatic.com/media/945e9d_2b97098295d341d493e4a07d80d6b57c~mv2.png" alt="Clarivore logo">
        <span>Clarivore</span>
      </a>
      <div class="simple-nav">
        <!-- Navigation populated by shared-nav.js -->
        <button id="navReturnMenu" type="button" style="display:none;">Back to menu</button>
      </div>
      <div class="mode-toggle-container" id="modeToggleContainer" style="display:none"></div>
    </div>
  </header>

  <main class="page-main">
    <div class="page-content">
      <div class="account-layout">
        <!-- Manager invite banner (shown when invite token present) -->
        <div id="invite-banner" class="auth-card" style="display:none;background:linear-gradient(135deg,#4c5ad4,#6366f1);border:none;margin-bottom:16px;">
          <h3 style="margin:0 0 8px;color:white;">You've been invited as a Manager</h3>
          <p style="margin:0;color:rgba(255,255,255,0.9);font-size:0.95rem;">Create an account or sign in to get manager access to your restaurant(s).</p>
        </div>

        <!-- Sign-in card -->
        <section id="auth-section" class="auth-card">
          <h2>Manage your allergy profile</h2>
          <p class="muted-text">Sign in to manage your saved allergens and view participating restaurants.</p>

          <!-- OAuth Buttons -->
          <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
            <button class="secondary-btn" id="apple-signin-btn" type="button" style="display:flex;align-items:center;justify-content:center;gap:8px;background:#000;color:#fff;border-color:#000;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
              </svg>
              Sign in with Apple
            </button>
            <button class="secondary-btn" id="google-signin-btn" type="button" style="display:flex;align-items:center;justify-content:center;gap:8px;">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Sign in with Google
            </button>
          </div>

          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="flex:1;height:1px;background:rgba(255,255,255,0.1);"></div>
            <span style="color:#8891b0;font-size:0.9rem;">or</span>
            <div style="flex:1;height:1px;background:rgba(255,255,255,0.1);"></div>
          </div>

          <input type="email" id="email" placeholder="Email" autocomplete="email">
          <input type="password" id="password" placeholder="Password" autocomplete="current-password">
          <div class="auth-actions">
            <button class="primary-btn" id="login-btn">Sign in</button>
            <button class="secondary-btn" id="start-signup-btn" type="button">Create an account</button>
          </div>
          <button class="link-btn" id="forgot-password-btn" type="button">Forgot your password?</button>
          <p id="auth-message" class="status-text"></p>
        </section>

        <!-- Sign-up card -->
        <section id="signup-view" class="auth-card" style="display:none;">
          <div class="auth-actions" style="justify-content:space-between;">
            <h2 style="margin:0;">Create your account</h2>
            <button class="secondary-btn" id="signup-back-btn" type="button">← Back</button>
          </div>

          <!-- OAuth Buttons for Signup -->
          <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
            <button class="secondary-btn" id="apple-signup-btn" type="button" style="display:flex;align-items:center;justify-content:center;gap:8px;background:#000;color:#fff;border-color:#000;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
              </svg>
              Sign up with Apple
            </button>
            <button class="secondary-btn" id="google-signup-btn" type="button" style="display:flex;align-items:center;justify-content:center;gap:8px;">
              <svg width="18" height="18" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Sign up with Google
            </button>
          </div>

          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="flex:1;height:1px;background:rgba(255,255,255,0.1);"></div>
            <span style="color:#8891b0;font-size:0.9rem;">or</span>
            <div style="flex:1;height:1px;background:rgba(255,255,255,0.1);"></div>
          </div>

          <input type="email" id="signup-email" placeholder="Email" autocomplete="email">
          <input type="password" id="signup-password" placeholder="Password" autocomplete="new-password">
          <div class="auth-actions">
            <button class="primary-btn" id="signup-submit-btn" type="button">Create account</button>
          </div>
          <p id="signup-message" class="status-text"></p>
        </section>

        <!-- Personal details -->
        <section id="details-section" class="auth-card" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 style="margin:0;">Your information</h2>
            <button class="primary-btn" id="details-save-btn" type="button" style="display:none;">Save changes</button>
          </div>
          <div class="form-row">
            <input type="text" id="profile-first-name" placeholder="First name" autocomplete="given-name">
            <input type="text" id="profile-last-name" placeholder="Last name" autocomplete="family-name">
          </div>
          <input type="email" id="profile-email" placeholder="Email" autocomplete="email">
          <p class="muted-text">Updating your email will send a confirmation message.</p>
          <p id="details-status" class="status-text"></p>
        </section>

        <!-- Allergen settings (shown when logged in) -->
        <section id="allergen-section" class="auth-card" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 style="margin:0;">My Allergens</h2>
            <button class="primary-btn" id="save-btn" type="button" style="display:none;">Save changes</button>
          </div>
          <div id="allergen-pills" class="allergen-select"></div>
          <p id="allergen-status" class="status-text" style="display:none;"></p>
        </section>

        <!-- Diets settings (shown when logged in) -->
        <section id="diet-section" class="auth-card" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
            <h2 style="margin:0;">My Diets</h2>
            <button class="primary-btn" id="save-diet-btn" type="button" style="display:none;">Save changes</button>
          </div>
          <div id="diet-pills" class="allergen-select"></div>
          <p id="diet-status" class="status-text" style="display:none;"></p>
        </section>

        <!-- Onboarding wizard (shown for new OAuth users) -->
        <section id="onboarding-section" class="auth-card" style="display:none;">
          <h2 style="margin:0 0 12px;">Welcome to Clarivore!</h2>
          <p id="onboarding-intro" class="muted-text" style="margin-bottom:20px;">Let's set up your allergy profile to get started.</p>

          <h3 style="margin:16px 0 8px;font-size:1.1rem;">Your name</h3>
          <div class="form-row">
            <input type="text" id="onboarding-first-name" placeholder="First name" autocomplete="given-name">
            <input type="text" id="onboarding-last-name" placeholder="Last name" autocomplete="family-name">
          </div>

          <div id="onboarding-allergen-block">
            <h3 style="margin:20px 0 8px;font-size:1.1rem;">Select your allergens</h3>
            <p class="muted-text" style="margin-bottom:12px;">Choose all allergens you need to avoid.</p>
            <div id="onboarding-allergen-pills" class="allergen-select"></div>
          </div>

          <div id="onboarding-diet-block">
            <h3 style="margin:20px 0 8px;font-size:1.1rem;">Diets</h3>
            <p class="muted-text" style="margin-bottom:12px;">Select any that apply to you.</p>
            <div id="onboarding-diet-pills" class="allergen-select"></div>
          </div>

          <div class="auth-actions" style="margin-top:24px;">
            <button class="primary-btn" id="onboarding-complete-btn" type="button">Complete setup</button>
          </div>
          <p id="onboarding-status" class="status-text"></p>
        </section>

        <!-- Sign out section (shown when logged in) -->
        <section id="sign-out-section" class="auth-card" style="display:none;">
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
            <button class="secondary-btn" id="sign-out-btn" type="button">Sign out</button>
            <button class="secondary-btn" id="delete-account-btn" type="button" style="background:#dc2626;border-color:#dc2626;color:white;">Delete account</button>
          </div>
          <div id="delete-account-warning" style="display:none;margin-top:16px;padding:16px;background:rgba(220,38,38,0.1);border:1px solid #dc2626;border-radius:8px;">
            <p style="margin:0 0 12px;font-weight:600;color:#dc2626;">⚠️ Are you sure you want to delete your account?</p>
            <p style="margin:0 0 16px;color:#8891b0;font-size:0.9rem;">This will permanently delete your account and all your data. This action cannot be undone.</p>
            <div style="display:flex;gap:12px;justify-content:center;">
              <button class="secondary-btn" id="cancel-delete-btn" type="button">Cancel</button>
              <button class="primary-btn" id="confirm-delete-btn" type="button" style="background:#dc2626;border-color:#dc2626;">Yes, delete my account</button>
            </div>
          </div>
        </section>

        <!-- Password reset -->
        <section id="password-reset-section" class="auth-card" style="display:none;">
          <h2 style="margin:0 0 12px;">Set a new password</h2>
          <p class="muted-text" style="margin-bottom:12px;">Enter a new password for your Clarivore account.</p>
          <input type="password" id="reset-password" placeholder="New password" autocomplete="new-password">
          <input type="password" id="reset-password-confirm" placeholder="Confirm new password" autocomplete="new-password">
          <div class="auth-actions">
            <button class="primary-btn" id="reset-password-btn" type="button">Update password</button>
            <button class="secondary-btn" id="reset-cancel-btn" type="button">Cancel</button>
          </div>
          <p id="reset-message" class="status-text"></p>
        </section>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/auth-redirect.js" defer></script>
  <script src="js/allergen-diet-config.js"></script>
  <script>
    // Initialize Supabase client for this page
    const SUPABASE_URL = 'https://fgoiyycctnwnghrvsilt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZnb2l5eWNjdG53bmdocnZzaWx0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzY1MjYsImV4cCI6MjA3NjAxMjUyNn0.xlSSXr0Gl7j-vsckrj-2anpPmp4BG2SUIdN-_dquSA8';
    const { createClient } = supabase;
    window.supabaseClient = window.supabaseClient || createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>
  <script type="module">
    import supabaseClient from './js/supabase-client.js';
    import { setupTopbar, attachSignOutHandler } from './js/shared-nav.js';
    import { fetchManagerRestaurants } from './js/manager-context.js';

    const allergenConfig = window.loadAllergenDietConfig
      ? await window.loadAllergenDietConfig({ supabaseClient })
      : (window.ALLERGEN_DIET_CONFIG || {});
    const ALLERGENS = Array.isArray(allergenConfig.ALLERGENS) ? allergenConfig.ALLERGENS : [];
    const DIETS = Array.isArray(allergenConfig.DIETS) ? allergenConfig.DIETS : [];
    const normalizeAllergen = typeof allergenConfig.normalizeAllergen === 'function'
      ? allergenConfig.normalizeAllergen
      : (value) => {
          const raw = String(value ?? '').trim();
          if (!raw) return '';
          if (!ALLERGENS.length) return raw;
          return ALLERGENS.includes(raw) ? raw : '';
        };
    const normalizeDietLabel = typeof allergenConfig.normalizeDietLabel === 'function'
      ? allergenConfig.normalizeDietLabel
      : (value) => {
          const raw = String(value ?? '').trim();
          if (!raw) return '';
          if (!DIETS.length) return raw;
          return DIETS.includes(raw) ? raw : '';
        };
    const formatAllergenLabel = typeof allergenConfig.formatAllergenLabel === 'function'
      ? allergenConfig.formatAllergenLabel
      : (value) => value;
    const getAllergenEmoji = typeof allergenConfig.getAllergenEmoji === 'function'
      ? allergenConfig.getAllergenEmoji
      : () => '';
    const getDietEmoji = typeof allergenConfig.getDietEmoji === 'function'
      ? allergenConfig.getDietEmoji
      : () => '';
    let selectedAllergies = [];
    let selectedDiets = [];
    let initialAllergies = []; // Track initial state for change detection
    let initialDiets = []; // Track initial state for change detection
    let initialFirstName = ''; // Track initial first name for change detection
    let initialLastName = ''; // Track initial last name for change detection
    let initialEmail = ''; // Track initial email for change detection
    let signupAllergies = [];
    let signupDiets = [];
    let onboardingAllergies = []; // Track allergens selected during onboarding
    let onboardingDiets = []; // Track diets selected during onboarding
    const QR_ALLERGIES_KEY = 'qrAllergies';
    const QR_DIETS_KEY = 'qrDiets';
    const readQrSelections = () => {
      const selections = { allergies: [], diets: [] };
      try {
        const rawAllergies = sessionStorage.getItem(QR_ALLERGIES_KEY);
        if (rawAllergies) {
          const parsed = JSON.parse(rawAllergies);
          if (Array.isArray(parsed)) {
            selections.allergies = parsed
              .map(normalizeAllergen)
              .filter(a => ALLERGENS.includes(a));
          }
        }
      } catch (_) {}
      try {
        const rawDiets = sessionStorage.getItem(QR_DIETS_KEY);
        if (rawDiets) {
          const parsed = JSON.parse(rawDiets);
          if (Array.isArray(parsed)) {
            selections.diets = parsed
              .map(normalizeDietLabel)
              .filter(d => DIETS.includes(d));
          }
        }
      } catch (_) {}
      return selections;
    };
    const clearQrSelections = () => {
      try {
        sessionStorage.removeItem(QR_ALLERGIES_KEY);
        sessionStorage.removeItem(QR_DIETS_KEY);
      } catch (_) {}
    };
    let currentUser = null;
    let inviteValidationCache = null;
    const params = new URLSearchParams(window.location.search);
    const redirectParam = params.get('redirect') || null;
    const returnSlug = params.get('returnSlug');
    const inviteToken = params.get('invite'); // Check for manager invitation token
    const hashParams = new URLSearchParams((window.location.hash || '').replace(/^#/, ''));
    let isRecoveryMode = hashParams.get('type') === 'recovery';
    if (isRecoveryMode) {
      window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
    }

    const navReturnMenu = document.getElementById('navReturnMenu');
    const authSection = document.getElementById('auth-section');
    const signupView = document.getElementById('signup-view');
    const detailsSection = document.getElementById('details-section');
    const allergenSection = document.getElementById('allergen-section');
    const dietSection = document.getElementById('diet-section');
    const signOutSection = document.getElementById('sign-out-section');
    const authMessage = document.getElementById('auth-message');
    const signupMessage = document.getElementById('signup-message');
    const allergenStatus = document.getElementById('allergen-status');
    const dietStatus = document.getElementById('diet-status');
    const detailsStatus = document.getElementById('details-status');
    const profileFirstName = document.getElementById('profile-first-name');
    const profileLastName = document.getElementById('profile-last-name');
    const profileEmail = document.getElementById('profile-email');
    const forgotPasswordBtn = document.getElementById('forgot-password-btn');
    const passwordResetSection = document.getElementById('password-reset-section');
    const resetPasswordInput = document.getElementById('reset-password');
    const resetPasswordConfirmInput = document.getElementById('reset-password-confirm');
    const resetPasswordBtn = document.getElementById('reset-password-btn');
    const resetCancelBtn = document.getElementById('reset-cancel-btn');
    const resetMessage = document.getElementById('reset-message');

    function setNavState(user, managerRestaurants = []) {
      const fromQr = !!returnSlug;
      const showBackToMenu = fromQr && !user;

      navReturnMenu.style.display = showBackToMenu ? 'inline-flex' : 'none';
      if (showBackToMenu) {
        navReturnMenu.onclick = () => {
          const url = `restaurant.html?slug=${encodeURIComponent(returnSlug)}&qr=1`;
          window.location.href = url;
        };
      }

      // Setup navigation with current page indicator
      if (!isRecoveryMode) {
        setupTopbar('account', user, { managerRestaurants });
        attachSignOutHandler(supabaseClient);
      }
    }

    async function checkAuth() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      currentUser = user;
      const OWNER_EMAIL = 'matt.29.ds@gmail.com';
      const isOwner = user?.email === OWNER_EMAIL;
      const isManager = user?.user_metadata?.role === 'manager';
      let managerRestaurants = [];
      if (user && (isManager || isOwner)) {
        managerRestaurants = await fetchManagerRestaurants(supabaseClient, user.id);
      }
      setNavState(user, managerRestaurants);

      if (user) {
        if (inviteToken) {
          try {
            const promptKey = `invitePromptSeen:${inviteToken}`;
            const alreadyPrompted = sessionStorage.getItem(promptKey) === '1';
            if (!alreadyPrompted) {
              const validation = await getInviteValidation();
              if (validation.isValid) {
                showInviteAccountChoiceModal({
                  onUseCurrent: async () => {
                    sessionStorage.setItem(promptKey, '1');
                    const result = await applyManagerInviteToCurrentUser(user, validation);
                    currentUser = result.user;
                    localStorage.setItem('clarivoreManagerMode', 'editor');
                    window.location.href = 'manager-dashboard.html';
                  },
                  onCreateNew: async () => {
                    sessionStorage.setItem(promptKey, '1');
                    await supabaseClient.auth.signOut();
                    window.location.href = `account.html?mode=signup&invite=${encodeURIComponent(inviteToken)}`;
                  }
                });
              }
            }
          } catch (err) {
            console.error('Invite prompt failed:', err);
          }
        }

        if (isRecoveryMode) {
          authSection.style.display = 'none';
          signupView.style.display = 'none';
          detailsSection.style.display = 'none';
          allergenSection.style.display = 'none';
          dietSection.style.display = 'none';
          signOutSection.style.display = 'none';
          document.getElementById('onboarding-section').style.display = 'none';
          passwordResetSection.style.display = 'flex';
          resetPasswordInput.value = '';
          resetPasswordConfirmInput.value = '';
          resetMessage.textContent = '';
          resetMessage.classList.remove('error','success');
          return;
        }

        // Check if user needs onboarding (incomplete profile)
        const needsOnboarding = await checkIfNeedsOnboarding(user);

        if (needsOnboarding) {
          // Show onboarding wizard
          authSection.style.display = 'none';
          signupView.style.display = 'none';
          detailsSection.style.display = 'none';
          allergenSection.style.display = 'none';
          dietSection.style.display = 'none';
          signOutSection.style.display = 'none';
          passwordResetSection.style.display = 'none';
          document.getElementById('onboarding-section').style.display = 'flex';
          await setupOnboarding(user);
        } else {
          // Show normal account page
          authSection.style.display = 'none';
          signupView.style.display = 'none';
          detailsSection.style.display = 'flex';
          signOutSection.style.display = 'flex';
          passwordResetSection.style.display = 'none';
          document.getElementById('onboarding-section').style.display = 'none';
          populateDetails(user);

          // Hide allergens/diets for managers in editor mode
          const isEditorMode = localStorage.getItem('clarivoreManagerMode') === 'editor';
          if ((isManager || isOwner) && isEditorMode) {
            allergenSection.style.display = 'none';
            dietSection.style.display = 'none';
          } else {
            allergenSection.style.display = 'flex';
            dietSection.style.display = 'flex';
            await loadAllergies();
            await loadDiets();
          }
          
          // Handle redirects
          if (redirectParam) {
            // If redirect is a full URL, use it directly
            if (redirectParam.startsWith('http://') || redirectParam.startsWith('https://')) {
              window.location.href = redirectParam;
              return;
            }
            // Handle specific redirect cases
            if (redirectParam === 'restaurants') {
              window.location.href = 'restaurants.html';
              return;
            }
            if (redirectParam === 'favorites') {
              window.location.href = 'favorites.html';
              return;
            }
          }
        }
      } else {
        allergenSection.style.display = 'none';
        dietSection.style.display = 'none';
        signOutSection.style.display = 'none';
        detailsSection.style.display = 'none';
        passwordResetSection.style.display = 'none';
        document.getElementById('onboarding-section').style.display = 'none';

        // Show invite banner if token present
        const inviteBanner = document.getElementById('invite-banner');
        if (inviteToken && inviteBanner) {
          inviteBanner.style.display = 'flex';
        }

        // Check mode parameter to show signup or signin
        const modeParam = params.get('mode');
        if(modeParam === 'signup') {
          authSection.style.display = 'none';
          signupView.style.display = 'flex';
        } else {
          signupView.style.display = 'none';
          authSection.style.display = 'flex';
        }
        if (isRecoveryMode) {
          isRecoveryMode = false;
        }
      }
    }

    async function checkIfNeedsOnboarding(user) {
      // Check if user has first name and last name
      const firstName = user?.user_metadata?.first_name || '';
      const lastName = user?.user_metadata?.last_name || '';

      if (!firstName || !lastName) {
        return true;
      }

      // Check if user has set up allergens
      const { data } = await supabaseClient
        .from('user_allergies')
        .select('allergens, diets')
        .eq('user_id', user.id)
        .maybeSingle();

      // If no record exists, needs onboarding
      if (!data) {
        return true;
      }

      // User has completed onboarding
      return false;
    }

    async function getInviteValidation() {
      if (!inviteToken) {
        return { token: null, status: 'missing', isValid: false, invitation: null, message: '' };
      }
      if (inviteValidationCache && inviteValidationCache.token === inviteToken) {
        return inviteValidationCache;
      }

      const result = {
        token: inviteToken,
        status: 'invalid',
        isValid: false,
        invitation: null,
        message: ''
      };

      try {
        const { data: invitation, error: inviteError } = await supabaseClient
          .from('manager_invites')
          .select('*')
          .eq('token', inviteToken)
          .maybeSingle();

        if (inviteError) {
          console.error('Invitation lookup error:', inviteError);
          result.status = 'error';
          result.message = 'Unable to validate invitation. Continuing as regular user.';
        } else if (!invitation) {
          result.status = 'missing';
          result.message = 'Invalid invitation link. Continuing as regular user.';
        } else if (invitation.used_at) {
          result.status = 'used';
          result.message = 'This invitation has already been used. Continuing as regular user.';
        } else if (!invitation.is_active) {
          result.status = 'revoked';
          result.message = 'This invitation has been revoked. Continuing as regular user.';
        } else if (invitation.expires_at && new Date(invitation.expires_at) < new Date()) {
          result.status = 'expired';
          result.message = 'This invitation has expired. Continuing as regular user.';
        } else {
          result.status = 'valid';
          result.isValid = true;
          result.invitation = invitation;
        }
      } catch (err) {
        console.error('Invitation lookup failed:', err);
        result.status = 'error';
        result.message = 'Unable to validate invitation. Continuing as regular user.';
      }

      inviteValidationCache = result;
      return result;
    }

    async function grantManagerInviteAccess(userId, restaurantIds) {
      const ids = Array.isArray(restaurantIds) ? restaurantIds : [];

      for (const restaurantId of ids) {
        const { error: linkError } = await supabaseClient
          .from('restaurant_managers')
          .insert({
            user_id: userId,
            restaurant_id: restaurantId,
            created_at: new Date().toISOString()
          });

        if (linkError) {
          console.log('[DEBUG] Restaurant manager link error (may be duplicate):', linkError);
        }
      }

      for (const restaurantId of ids) {
        const { error: accessError } = await supabaseClient
          .from('manager_restaurant_access')
          .insert({
            user_id: userId,
            restaurant_id: restaurantId,
            granted_by: null
          });

        if (accessError) {
          console.log('[DEBUG] Manager restaurant access error (may be duplicate):', accessError);
        }
      }

      if (inviteToken) {
        const { error: updateError } = await supabaseClient
          .from('manager_invites')
          .update({
            used_at: new Date().toISOString(),
            used_by: userId
          })
          .eq('token', inviteToken);

        console.log('[DEBUG] Invitation marked as used. error:', updateError);
      }
    }

    async function applyManagerInviteToCurrentUser(user, validation) {
      if (!validation?.isValid) {
        throw new Error('Manager invitation is not valid.');
      }

      const restaurantIds = validation.invitation?.restaurant_ids || [];
      const nextMetadata = { ...(user?.user_metadata || {}), role: 'manager' };
      const { data: userData, error: userError } = await supabaseClient.auth.updateUser({
        data: nextMetadata
      });
      if (userError) throw userError;

      const updatedUser = userData?.user || user;
      if (restaurantIds.length > 0) {
        await grantManagerInviteAccess(updatedUser.id, restaurantIds);
      } else {
        await grantManagerInviteAccess(updatedUser.id, []);
      }

      return {
        user: updatedUser,
        restaurantIds
      };
    }

    function showInviteAccountChoiceModal({ onUseCurrent, onCreateNew }) {
      const backdrop = document.createElement('div');
      backdrop.style.cssText = [
        'position: fixed',
        'inset: 0',
        'background: rgba(8, 12, 26, 0.82)',
        'display: flex',
        'align-items: center',
        'justify-content: center',
        'z-index: 10001',
        'padding: 20px'
      ].join(';');

      backdrop.innerHTML = `
        <div style="width:min(520px, 100%);background:#0f1638;border:1px solid rgba(76,90,212,0.4);border-radius:16px;padding:24px;box-shadow:0 24px 60px rgba(0,0,0,0.45);color:#e9ecff;">
          <h3 style="margin:0 0 12px 0;font-size:1.2rem">Apply manager invite</h3>
          <p style="margin:0 0 20px 0;color:#a8b2d6;line-height:1.5">
            You are already signed in. Should we grant manager access to your current account or create a new account for this invite?
          </p>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <button type="button" class="invite-use-current" style="padding:12px 16px;border-radius:10px;border:1px solid #22c55e;background:#17663a;color:#fff;font-weight:600;cursor:pointer">Use current account</button>
            <button type="button" class="invite-create-new" style="padding:12px 16px;border-radius:10px;border:1px solid rgba(148,163,184,0.6);background:transparent;color:#e9ecff;font-weight:600;cursor:pointer">Create a new account</button>
          </div>
        </div>
      `;

      const useBtn = backdrop.querySelector('.invite-use-current');
      const newBtn = backdrop.querySelector('.invite-create-new');
      const cleanup = () => {
        if (backdrop.parentNode) backdrop.parentNode.removeChild(backdrop);
      };

      if (useBtn) {
        useBtn.addEventListener('click', async () => {
          useBtn.disabled = true;
          useBtn.textContent = 'Granting access...';
          try {
            await onUseCurrent?.();
          } finally {
            cleanup();
          }
        });
      }

      if (newBtn) {
        newBtn.addEventListener('click', async () => {
          newBtn.disabled = true;
          newBtn.textContent = 'Redirecting...';
          try {
            await onCreateNew?.();
          } finally {
            cleanup();
          }
        });
      }

      document.body.appendChild(backdrop);
    }

    async function updateOnboardingForInvite() {
      const intro = document.getElementById('onboarding-intro');
      const allergenBlock = document.getElementById('onboarding-allergen-block');
      const dietBlock = document.getElementById('onboarding-diet-block');

      if (!inviteToken) {
        if (intro) {
          intro.textContent = "Let's set up your allergy profile to get started.";
        }
        if (allergenBlock) allergenBlock.style.display = '';
        if (dietBlock) dietBlock.style.display = '';
        return { isManagerInvite: false, validation: null };
      }

      const validation = await getInviteValidation();
      if (validation.isValid) {
        if (intro) {
          intro.textContent = "You're joining as a manager. We'll skip allergy and diet preferences for now.";
        }
        if (allergenBlock) allergenBlock.style.display = 'none';
        if (dietBlock) dietBlock.style.display = 'none';
        return { isManagerInvite: true, validation };
      }

      if (intro) {
        intro.textContent = "Let's set up your allergy profile to get started.";
      }
      if (allergenBlock) allergenBlock.style.display = '';
      if (dietBlock) dietBlock.style.display = '';
      return { isManagerInvite: false, validation };
    }

    async function setupOnboarding(user) {
      // Pre-fill name fields if available from OAuth
      const onboardingFirstName = document.getElementById('onboarding-first-name');
      const onboardingLastName = document.getElementById('onboarding-last-name');

      onboardingFirstName.value = user?.user_metadata?.first_name || '';
      onboardingLastName.value = user?.user_metadata?.last_name || '';

      // Reset selections
      onboardingAllergies = [];
      onboardingDiets = [];
      const qrSelections = readQrSelections();
      if (qrSelections.allergies.length) {
        onboardingAllergies = [...qrSelections.allergies];
      }
      if (qrSelections.diets.length) {
        onboardingDiets = [...qrSelections.diets];
      }

      const { isManagerInvite } = await updateOnboardingForInvite();

      if (isManagerInvite) {
        const allergenContainer = document.getElementById('onboarding-allergen-pills');
        const dietContainer = document.getElementById('onboarding-diet-pills');
        if (allergenContainer) allergenContainer.innerHTML = '';
        if (dietContainer) dietContainer.innerHTML = '';
        return;
      }

      // Render allergen and diet pills
      renderOnboardingAllergens();
      renderOnboardingDiets();
    }

    function renderOnboardingAllergens() {
      const container = document.getElementById('onboarding-allergen-pills');
      container.innerHTML = '';
      ALLERGENS.forEach(allergen => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (onboardingAllergies.includes(allergen) ? ' active' : '');
        const emoji = getAllergenEmoji(allergen) || '';
        pill.textContent = emoji + ' ' + formatAllergenLabel(allergen);
        pill.onclick = () => {
          if (onboardingAllergies.includes(allergen)) {
            onboardingAllergies = onboardingAllergies.filter(a => a !== allergen);
          } else {
            onboardingAllergies.push(allergen);
          }
          renderOnboardingAllergens();
        };
        container.appendChild(pill);
      });
    }

    function renderOnboardingDiets() {
      const container = document.getElementById('onboarding-diet-pills');
      container.innerHTML = '';
      DIETS.forEach(diet => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (onboardingDiets.includes(diet) ? ' active' : '');
        const emoji = getDietEmoji(diet) || '';
        pill.textContent = emoji + ' ' + diet;
        pill.onclick = () => {
          if (onboardingDiets.includes(diet)) {
            onboardingDiets = onboardingDiets.filter(d => d !== diet);
          } else {
            onboardingDiets.push(diet);
          }
          renderOnboardingDiets();
        };
        container.appendChild(pill);
      });
    }

    async function loadAllergies() {
      if (!currentUser) return;
      allergenStatus.textContent = '';
      allergenStatus.classList.remove('error','success');
      const { data } = await supabaseClient
        .from('user_allergies')
        .select('allergens')
        .eq('user_id', currentUser.id)
        .maybeSingle();
      // Filter out any allergens not in current ALLERGENS list (removes legacy data like 'gluten')
      const dbAllergens = (data?.allergens || []).map(normalizeAllergen).filter(Boolean);
      selectedAllergies = dbAllergens.filter(a => ALLERGENS.includes(a));
      // Save initial state for change detection
      initialAllergies = [...selectedAllergies];
      // If we filtered anything out, save the cleaned list back to the database
      if (dbAllergens.length !== selectedAllergies.length) {
        await saveAllergies(selectedAllergies);
      }
      renderAllergens();
    }

    function renderAllergens() {
      const container = document.getElementById('allergen-pills');
      container.innerHTML = '';
      ALLERGENS.forEach(allergen => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (selectedAllergies.includes(allergen) ? ' active' : '');
        const emoji = getAllergenEmoji(allergen) || '';
        pill.textContent = emoji + ' ' + formatAllergenLabel(allergen);
        pill.onclick = () => {
          if (selectedAllergies.includes(allergen)) {
            selectedAllergies = selectedAllergies.filter(a => a !== allergen);
          } else {
            selectedAllergies.push(allergen);
          }
          renderAllergens();
        };
        container.appendChild(pill);
      });

      // Show/hide save button based on whether changes were made
      const saveBtn = document.getElementById('save-btn');
      const hasChanges = JSON.stringify([...selectedAllergies].sort()) !== JSON.stringify([...initialAllergies].sort());
      saveBtn.style.display = hasChanges ? 'block' : 'none';
    }

    async function loadDiets() {
      if (!currentUser) return;
      dietStatus.textContent = '';
      dietStatus.classList.remove('error','success');
      const { data } = await supabaseClient
        .from('user_allergies')
        .select('diets')
        .eq('user_id', currentUser.id)
        .maybeSingle();
      selectedDiets = (data?.diets || []).map(normalizeDietLabel).filter(Boolean);
      // Save initial state for change detection
      initialDiets = [...selectedDiets];
      renderDiets();
    }

    function renderDiets() {
      const container = document.getElementById('diet-pills');
      container.innerHTML = '';
      DIETS.forEach(diet => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (selectedDiets.includes(diet) ? ' active' : '');
        const emoji = getDietEmoji(diet) || '';
        pill.textContent = emoji + ' ' + diet;
        pill.onclick = () => {
          if (selectedDiets.includes(diet)) {
            selectedDiets = selectedDiets.filter(d => d !== diet);
          } else {
            selectedDiets.push(diet);
          }
          renderDiets();
        };
        container.appendChild(pill);
      });

      // Show/hide save button based on whether changes were made
      const saveDietBtn = document.getElementById('save-diet-btn');
      const hasChanges = JSON.stringify([...selectedDiets].sort()) !== JSON.stringify([...initialDiets].sort());
      saveDietBtn.style.display = hasChanges ? 'block' : 'none';
    }

    async function saveDiets(diets) {
      if (!currentUser) return;
      // Get current allergens to preserve them
      const { data: current } = await supabaseClient
        .from('user_allergies')
        .select('allergens, diets')
        .eq('user_id', currentUser.id)
        .maybeSingle();

      const payload = {
        user_id: currentUser.id,
        allergens: current?.allergens || [],
        updated_at: new Date().toISOString()
      };

      // Only include diets if the column exists
      if (current && 'diets' in current) {
        payload.diets = diets.map(normalizeDietLabel).filter(Boolean);
      } else {
        // If diets column doesn't exist, throw a helpful error
        throw new Error('Diets feature requires a database update. Please contact support.');
      }

      const { error } = await supabaseClient
        .from('user_allergies')
        .upsert(payload, { onConflict: 'user_id' });
      if (error) throw error;
    }

    function renderSignupAllergens() {
      const container = document.getElementById('signup-allergen-pills');
      container.innerHTML = '';
      ALLERGENS.forEach(allergen => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (signupAllergies.includes(allergen) ? ' active' : '');
        const emoji = getAllergenEmoji(allergen) || '';
        pill.textContent = emoji + ' ' + formatAllergenLabel(allergen);
        pill.onclick = () => {
          if (signupAllergies.includes(allergen)) {
            signupAllergies = signupAllergies.filter(a => a !== allergen);
          } else {
            signupAllergies.push(allergen);
          }
          renderSignupAllergens();
        };
        container.appendChild(pill);
      });
    }

    function renderSignupDiets() {
      const container = document.getElementById('signup-diet-pills');
      container.innerHTML = '';
      DIETS.forEach(diet => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'chip' + (signupDiets.includes(diet) ? ' active' : '');
        const emoji = getDietEmoji(diet) || '';
        pill.textContent = emoji + ' ' + diet;
        pill.onclick = () => {
          if (signupDiets.includes(diet)) {
            signupDiets = signupDiets.filter(d => d !== diet);
          } else {
            signupDiets.push(diet);
          }
          renderSignupDiets();
        };
        container.appendChild(pill);
      });
    }

    async function saveAllergies(allergies) {
      if (!currentUser) return;
      // Get current diets to preserve them
      const { data: current } = await supabaseClient
        .from('user_allergies')
        .select('diets')
        .eq('user_id', currentUser.id)
        .maybeSingle();

      const payload = {
        user_id: currentUser.id,
        allergens: allergies.map(normalizeAllergen).filter(Boolean),
        updated_at: new Date().toISOString()
      };

      // Only include diets if the column exists in the response
      if (current && 'diets' in current) {
        payload.diets = current.diets || [];
      }

      const { error } = await supabaseClient
        .from('user_allergies')
        .upsert(payload, { onConflict: 'user_id' });
      if (error) throw error;
    }

    function populateDetails(user) {
      profileFirstName.value = user?.user_metadata?.first_name || '';
      profileLastName.value = user?.user_metadata?.last_name || '';
      profileEmail.value = user?.email || '';

      // Save initial values for change detection
      initialFirstName = profileFirstName.value;
      initialLastName = profileLastName.value;
      initialEmail = profileEmail.value;

      detailsStatus.textContent = '';
      detailsStatus.classList.remove('error','success');

      // Check for changes immediately in case values were set
      checkDetailsChanged();
    }

    function checkDetailsChanged() {
      const saveBtn = document.getElementById('details-save-btn');
      const hasChanges =
        profileFirstName.value !== initialFirstName ||
        profileLastName.value !== initialLastName ||
        profileEmail.value !== initialEmail;
      saveBtn.style.display = hasChanges ? 'block' : 'none';
    }

    // Add event listeners to profile fields to detect changes
    if(profileFirstName) profileFirstName.addEventListener('input', checkDetailsChanged);
    if(profileLastName) profileLastName.addEventListener('input', checkDetailsChanged);
    if(profileEmail) profileEmail.addEventListener('input', checkDetailsChanged);

    document.getElementById('save-btn').onclick = async () => {
      if (!currentUser) return;
      const saveBtn = document.getElementById('save-btn');
      const originalText = saveBtn.textContent;
      allergenStatus.textContent = '';
      allergenStatus.style.display = 'none';
      try {
        await saveAllergies(selectedAllergies);
        // Update initial state to match saved state
        initialAllergies = [...selectedAllergies];
        saveBtn.textContent = 'Saved!';
        saveBtn.style.background = '#22c55e';
        setTimeout(() => {
          saveBtn.textContent = originalText;
          saveBtn.style.background = '';
          // Hide button after save success
          saveBtn.style.display = 'none';
        }, 2000);
      } catch (error) {
        allergenStatus.textContent = error.message || 'Failed to save.';
        allergenStatus.classList.remove('success');
        allergenStatus.classList.add('error');
        allergenStatus.style.display = 'block';
      }
    };

    document.getElementById('save-diet-btn').onclick = async () => {
      if (!currentUser) return;
      const saveDietBtn = document.getElementById('save-diet-btn');
      const originalText = saveDietBtn.textContent;
      dietStatus.textContent = '';
      dietStatus.style.display = 'none';
      try {
        await saveDiets(selectedDiets);
        // Update initial state to match saved state
        initialDiets = [...selectedDiets];
        saveDietBtn.textContent = 'Saved!';
        saveDietBtn.style.background = '#22c55e';
        setTimeout(() => {
          saveDietBtn.textContent = originalText;
          saveDietBtn.style.background = '';
          // Hide button after save success
          saveDietBtn.style.display = 'none';
        }, 2000);
      } catch (error) {
        dietStatus.textContent = error.message || 'Failed to save.';
        dietStatus.classList.remove('success');
        dietStatus.classList.add('error');
        dietStatus.style.display = 'block';
      }
    };

    document.getElementById('login-btn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      authMessage.textContent = '';
      authMessage.classList.remove('error', 'success');

      if (!email || !password) {
        authMessage.textContent = 'Please enter your email and password.';
        authMessage.classList.add('error');
        return;
      }

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        authMessage.textContent = error.message;
        authMessage.classList.add('error');
      } else {
        authMessage.textContent = '';
        await checkAuth();
      }
    };

    forgotPasswordBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      authMessage.textContent = '';
      authMessage.classList.remove('error','success');
      if (!email) {
        authMessage.textContent = 'Enter your email first, then tap "Forgot your password?"';
        authMessage.classList.add('error');
        return;
      }
      try {
        const redirectTo = `${window.location.origin}/account.html#type=recovery`;
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo });
        if (error) throw error;
        authMessage.textContent = 'Password reset email sent! Check your inbox.';
        authMessage.classList.add('success');
      } catch (error) {
        authMessage.textContent = error.message || 'Unable to send reset email.';
        authMessage.classList.add('error');
      }
    });

    document.getElementById('start-signup-btn').onclick = () => {
      authMessage.textContent = '';
      // Carry over email/password from sign-in form if entered
      const signinEmail = document.getElementById('email').value.trim();
      const signinPassword = document.getElementById('password').value;
      if (signinEmail) {
        document.getElementById('signup-email').value = signinEmail;
      }
      if (signinPassword) {
        document.getElementById('signup-password').value = signinPassword;
      }
      authSection.style.display = 'none';
      signupView.style.display = 'flex';
      signupAllergies = [];
      signupDiets = [];
      signupMessage.textContent = '';
      signupMessage.classList.remove('error','success');
    };

    document.getElementById('signup-back-btn').onclick = () => {
      signupMessage.textContent = '';
      signupView.style.display = 'none';
      authSection.style.display = 'flex';
      signupAllergies = [];
      signupDiets = [];
    };

    document.getElementById('signup-submit-btn').onclick = async () => {
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      signupMessage.textContent = '';
      signupMessage.classList.remove('error', 'success');

      if (!email || !password) {
        signupMessage.textContent = 'Please enter both email and password.';
        signupMessage.classList.add('error');
        return;
      }

      const { error } = await supabaseClient.auth.signUp({
        email,
        password
      });

      if (error) {
        signupMessage.textContent = error.message;
        signupMessage.classList.add('error');
        return;
      }

      signupMessage.textContent = 'Account created! Check your email to confirm.';
      signupMessage.classList.add('success');

      // Attempt immediate login if session returned (email confirmations disabled)
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        // User will be directed to onboarding wizard to complete profile
        await checkAuth();
      } else {
        setTimeout(() => {
          signupView.style.display = 'none';
          authSection.style.display = 'flex';
        }, 1500);
      }
    };

    document.getElementById('details-save-btn').onclick = async () => {
      if (!currentUser) return;
      const saveBtn = document.getElementById('details-save-btn');
      const originalText = saveBtn.textContent;
      const firstName = profileFirstName.value.trim();
      const lastName = profileLastName.value.trim();
      const email = profileEmail.value.trim();
      detailsStatus.textContent = '';
      detailsStatus.classList.remove('error','success');

      if (!firstName || !lastName || !email) {
        detailsStatus.textContent = 'Please fill in your first name, last name, and email.';
        detailsStatus.classList.add('error');
        return;
      }

      const payload = {
        data: { first_name: firstName, last_name: lastName }
      };
      if (email !== currentUser.email) {
        payload.email = email;
      }

      const { data, error } = await supabaseClient.auth.updateUser(payload);
      if (error) {
        detailsStatus.textContent = error.message;
        detailsStatus.classList.add('error');
        return;
      }

      currentUser = data.user;

      // Update initial state to match saved state
      initialFirstName = firstName;
      initialLastName = lastName;
      initialEmail = email;

      // Show success feedback
      saveBtn.textContent = 'Saved!';
      saveBtn.style.background = '#22c55e';
      setTimeout(() => {
        saveBtn.textContent = originalText;
        saveBtn.style.background = '';
        // Hide button after save success
        saveBtn.style.display = 'none';
      }, 2000);

      setNavState(currentUser);
    };

    // Onboarding complete button handler
    document.getElementById('onboarding-complete-btn').addEventListener('click', async () => {
      const onboardingFirstName = document.getElementById('onboarding-first-name').value.trim();
      const onboardingLastName = document.getElementById('onboarding-last-name').value.trim();
      const onboardingStatus = document.getElementById('onboarding-status');

      onboardingStatus.textContent = '';
      onboardingStatus.classList.remove('error', 'success');

      // Validate required fields
      if (!onboardingFirstName || !onboardingLastName) {
        onboardingStatus.textContent = 'Please enter your first and last name.';
        onboardingStatus.classList.add('error');
        return;
      }

      try {
        let userRole = 'customer';
        let restaurantIds = [];
        let entryPage = 'home';

        // Check if user has a manager invitation token
        if (inviteToken) {
          const inviteValidation = await getInviteValidation();
          if (inviteValidation.isValid) {
            userRole = 'manager';
            restaurantIds = inviteValidation.invitation?.restaurant_ids || [];
            entryPage = inviteValidation.invitation?.entry_page || 'home';
          } else if (inviteValidation.message) {
            onboardingStatus.textContent = inviteValidation.message;
            onboardingStatus.classList.add('error');
          }
        }

        // Update user metadata with name and role
        const { data: userData, error: userError } = await supabaseClient.auth.updateUser({
          data: {
            first_name: onboardingFirstName,
            last_name: onboardingLastName,
            role: userRole
          }
        });

        if (userError) throw userError;

        // Save allergens and diets
        await supabaseClient
          .from('user_allergies')
          .upsert({
            user_id: currentUser.id,
            allergens: onboardingAllergies,
            diets: onboardingDiets,
            updated_at: new Date().toISOString()
          }, { onConflict: 'user_id' });

        // If manager, grant restaurant access and mark invitation as used
        if (userRole === 'manager') {
          console.log('[DEBUG] Linking manager to restaurants. user_id:', currentUser.id, 'restaurant_ids:', restaurantIds);
          await grantManagerInviteAccess(currentUser.id, restaurantIds);
        }

        clearQrSelections();

        // Determine redirect URL based on entry page from invitation
        let redirectUrl = 'restaurants.html';

        if (userRole === 'manager') {
          redirectUrl = 'manager-dashboard.html';
        } else if (redirectParam) {
          if (redirectParam.startsWith('http://') || redirectParam.startsWith('https://')) {
            redirectUrl = redirectParam;
          } else if (redirectParam === 'favorites') {
            redirectUrl = 'favorites.html';
          } else if (redirectParam === 'restaurants') {
            redirectUrl = 'restaurants.html';
          }
        }

        window.location.href = redirectUrl;
      } catch (error) {
        console.error('Onboarding error:', error);
        onboardingStatus.textContent = error.message || 'Failed to complete setup. Please try again.';
        onboardingStatus.classList.add('error');
      }
    });

    // Sign out button handler
    const signOutBtn = document.getElementById('sign-out-btn');
    if (signOutBtn) {
      signOutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        selectedAllergies = [];
        selectedDiets = [];
        signupAllergies = [];
        signupDiets = [];
        onboardingAllergies = [];
        onboardingDiets = [];
        await checkAuth();
      });
    }

    // Delete account button handlers
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const deleteAccountWarning = document.getElementById('delete-account-warning');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

    if (deleteAccountBtn) {
      deleteAccountBtn.addEventListener('click', () => {
        deleteAccountWarning.style.display = 'block';
        deleteAccountWarning.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      });
    }

    if (cancelDeleteBtn) {
      cancelDeleteBtn.addEventListener('click', () => {
        deleteAccountWarning.style.display = 'none';
      });
    }

    if (confirmDeleteBtn) {
      confirmDeleteBtn.addEventListener('click', async () => {
        if (!currentUser) return;

        try {
          // Call the delete_user RPC function which handles all cleanup
          const { error: rpcError } = await supabaseClient.rpc('delete_user');

          if (rpcError) {
            console.error('RPC delete error:', rpcError);

            // Fallback: delete data manually
            await supabaseClient
              .from('user_allergies')
              .delete()
              .eq('user_id', currentUser.id);

            await supabaseClient
              .from('restaurant_managers')
              .delete()
              .eq('user_id', currentUser.id);
          }

          // Sign out
          await supabaseClient.auth.signOut();
          alert('Your account has been deleted successfully.');
          window.location.href = '/';
        } catch (error) {
          console.error('Account deletion error:', error);
          alert('Failed to delete account: ' + (error.message || 'Please contact support.'));
        }
      });
    }

    resetPasswordBtn.addEventListener('click', async () => {
      resetMessage.textContent = '';
      resetMessage.classList.remove('error','success');
      const password = resetPasswordInput.value;
      const confirm = resetPasswordConfirmInput.value;
      if (!password || !confirm) {
        resetMessage.textContent = 'Enter and confirm your new password.';
        resetMessage.classList.add('error');
        return;
      }
      if (password !== confirm) {
        resetMessage.textContent = 'Passwords do not match.';
        resetMessage.classList.add('error');
        return;
      }
      if (password.length < 8) {
        resetMessage.textContent = 'Use at least 8 characters for your new password.';
        resetMessage.classList.add('error');
        return;
      }
      try {
        const { error } = await supabaseClient.auth.updateUser({ password });
        if (error) throw error;
        resetMessage.textContent = 'Password updated! You are signed in.';
        resetMessage.classList.add('success');
        isRecoveryMode = false;
        setTimeout(() => {
          checkAuth();
        }, 1200);
      } catch (error) {
        resetMessage.textContent = error.message || 'Unable to update password.';
        resetMessage.classList.add('error');
      }
    });

    resetCancelBtn.addEventListener('click', async () => {
      resetMessage.textContent = '';
      resetMessage.classList.remove('error','success');
      resetPasswordInput.value = '';
      resetPasswordConfirmInput.value = '';
      isRecoveryMode = false;
      await checkAuth();
    });

    const NATIVE_AUTH_SCHEME = 'com.clarivore.app';
    const NATIVE_AUTH_CALLBACK = 'auth-callback';
    const isNativePlatform = () => {
      if (window.Capacitor?.isNativePlatform) {
        return window.Capacitor.isNativePlatform();
      }
      if (window.Capacitor?.getPlatform) {
        return window.Capacitor.getPlatform() !== 'web';
      }
      const protocol = window.location.protocol;
      if (protocol === 'capacitor:' || protocol === 'ionic:' || protocol === 'file:') {
        return true;
      }
      if (window.navigator?.userAgent?.includes('Capacitor')) {
        return true;
      }
      return false;
    };
    const getNativeRedirectUrl = () => `${NATIVE_AUTH_SCHEME}://${NATIVE_AUTH_CALLBACK}`;

    async function handleNativeOAuthUrl(url) {
      if (!url || !url.startsWith(`${NATIVE_AUTH_SCHEME}://`)) return;
      try {
        const parsedUrl = new URL(url);
        const hashParams = new URLSearchParams(parsedUrl.hash.replace(/^#/, ''));
        const searchParams = parsedUrl.searchParams;
        const errorDescription =
          searchParams.get('error_description') ||
          hashParams.get('error_description') ||
          searchParams.get('error') ||
          hashParams.get('error');
        if (errorDescription) {
          throw new Error(errorDescription);
        }
        const code = searchParams.get('code') || hashParams.get('code');
        if (code) {
          const { error } = await supabaseClient.auth.exchangeCodeForSession(code);
          if (error) throw error;
        } else {
          const accessToken =
            hashParams.get('access_token') || searchParams.get('access_token');
          const refreshToken =
            hashParams.get('refresh_token') || searchParams.get('refresh_token');
          if (accessToken && refreshToken) {
            const { error } = await supabaseClient.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken,
              expires_in: Number(hashParams.get('expires_in') || 0) || undefined,
              token_type: hashParams.get('token_type') || undefined,
            });
            if (error) throw error;
          }
        }
        const browser = window.Capacitor?.Plugins?.Browser;
        if (browser?.close) {
          await browser.close();
        }
        await checkAuth();
      } catch (error) {
        authMessage.textContent = error.message || 'OAuth sign-in failed';
        authMessage.classList.add('error');
      }
    }

    function registerNativeOAuthListener() {
      if (window.__clarivoreNativeAuthListener) return;
      const app =
        window.Capacitor?.Plugins?.App || window.Capacitor?.App || window.App;
      if (!app?.addListener || !isNativePlatform()) return;
      window.__clarivoreNativeAuthListener = true;
      app.addListener('appUrlOpen', ({ url }) => {
        handleNativeOAuthUrl(url);
      });
    }

    async function checkLaunchUrl() {
      const app =
        window.Capacitor?.Plugins?.App || window.Capacitor?.App || window.App;
      if (!app?.getLaunchUrl || !isNativePlatform()) return;
      try {
        const { url } = await app.getLaunchUrl();
        if (url) {
          await handleNativeOAuthUrl(url);
        }
      } catch (_) {}
    }

    // OAuth handlers
    async function handleOAuthSignIn(provider) {
      try {
        const isNative = isNativePlatform();
        // Build redirect URL with any existing parameters
        const redirectParams = new URLSearchParams();
        if (redirectParam) redirectParams.set('redirect', redirectParam);
        if (inviteToken) redirectParams.set('invite', inviteToken);
        const queryString = redirectParams.toString();
        const redirectTo = isNative
          ? getNativeRedirectUrl()
          : `${window.location.origin}/account.html${queryString ? '?' + queryString : ''}`;

        const { data, error } = await supabaseClient.auth.signInWithOAuth({
          provider: provider,
          options: {
            redirectTo: redirectTo,
            skipBrowserRedirect: isNative
          }
        });
        if (error) {
          authMessage.textContent = error.message;
          authMessage.classList.add('error');
          return;
        }
        if (isNative && data?.url) {
          const browser = window.Capacitor?.Plugins?.Browser;
          if (browser?.open) {
            await browser.open({ url: data.url });
          } else {
            window.location.href = data.url;
          }
        }
      } catch (error) {
        authMessage.textContent = error.message || 'OAuth sign-in failed';
        authMessage.classList.add('error');
      }
    }

    // Sign in with Apple (sign-in page)
    document.getElementById('apple-signin-btn')?.addEventListener('click', () => {
      handleOAuthSignIn('apple');
    });

    // Sign in with Google (sign-in page)
    document.getElementById('google-signin-btn')?.addEventListener('click', () => {
      handleOAuthSignIn('google');
    });

    // Sign up with Apple (signup page)
    document.getElementById('apple-signup-btn')?.addEventListener('click', () => {
      handleOAuthSignIn('apple');
    });

    // Sign up with Google (signup page)
    document.getElementById('google-signup-btn')?.addEventListener('click', () => {
      handleOAuthSignIn('google');
    });

    window.addEventListener('clarivore:auth:signed-in', () => {
      checkAuth();
    });
    window.addEventListener('clarivore:auth:error', (event) => {
      const message =
        event?.detail?.error?.message || 'OAuth sign-in failed';
      authMessage.textContent = message;
      authMessage.classList.add('error');
    });
    registerNativeOAuthListener();
    checkLaunchUrl();
    checkAuth();
  </script>
  <script type="module" src="js/report-modal.js"></script>
</body>
</html>
