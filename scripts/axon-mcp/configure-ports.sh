#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

mkdir -p "$SCRIPT_DIR"

cat >"$AXON_LOCAL_ENV_FILE" <<EOF
# Auto-generated by scripts/axon-mcp/configure-ports.sh
# You can edit this file to pin or adjust local Axon ports.
AXON_API_PORT=$AXON_API_PORT
AXON_MCP_PORT=$AXON_MCP_PORT
AXON_POSTGRES_PORT=$AXON_POSTGRES_PORT
AXON_REDIS_PORT=$AXON_REDIS_PORT
AXON_DISABLE_PORT_AUTOSELECT=1

# Candidate fallback pools (used when preferred port is busy):
AXON_API_PORT_CANDIDATES="$AXON_API_PORT_CANDIDATES"
AXON_MCP_PORT_CANDIDATES="$AXON_MCP_PORT_CANDIDATES"
AXON_POSTGRES_PORT_CANDIDATES="$AXON_POSTGRES_PORT_CANDIDATES"
AXON_REDIS_PORT_CANDIDATES="$AXON_REDIS_PORT_CANDIDATES"
EOF

log "Wrote local port configuration: $AXON_LOCAL_ENV_FILE"
log "API=$AXON_API_PORT MCP=$AXON_MCP_PORT POSTGRES=$AXON_POSTGRES_PORT REDIS=$AXON_REDIS_PORT"
